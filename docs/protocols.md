# Protocol details

The registry API protocol is composed of two major parts: voucher generation and payments.
Both parts are based on 2&nbsp;API methods.

## Voucher creation request

Request from *instrument* to *registry*, generating a new voucher generation request.

`POST /api/v1/voucher/create`

### Payload

```json
{
    "SourceId": 1,
    "Nonce": "91553f9f3d404a5399a7a7d651bb0ddd",
    "Payload": "<see below>"
}
```

| Property | Type | Description |
| --- | --- | --- |
| `SourceID` | integer | Unique identifier of the source requesting new vouchers. |
| `Nonce` | string | Unique (per-source) string that ensures non-repetition. |
| `Payload` | string | JSON object encrypted with the registry’s public key. |

The JSON object `Payload` has the following structure:

```json
{
    "SourceId": 1,
    "Nonce": "91553f9f3d404a5399a7a7d651bb0ddd",
    "Vouchers": [
        {
            "Aim": "https://wom.social/api/v1/aim/1",
            "Latitude": 12.34,
            "Longitude": 12.34,
            "Timestamp": "timestamp in ISO 8601 format"
        }
    ]
}
```

| Property | Type | Description |
| --- | --- | --- |
| `SourceID` | integer | Unique source identifier, must match that of container object. |
| `Nonce` | string | Non-repetition string, must match that of container object. |
| `Vouchers` | string | Array of voucher information. |
| `Aim` | string | URL identifying a *common good* aim within the WOM&nbsp;platform. |
| `Latitude` | numeric | |
| `Longitude` | numeric | |
| `Timestamp` | string | Time and date, UTC, ISO&nbsp;8601 format. |

### Result

```json
{
    "Payload": "<see below>"
}
```

`Payload` is a JSON-encoded object, encrypted with the *source's public key*.
Contents of the object are shown below:

```json
{
    "RegistryUrl": "https://wom.social",
    "Nonce": "91553f9f3d404a5399a7a7d651bb0ddd",
    "Otc": "8b7abe3dda5f42e0b8235a819b0088b8"
}
```

| Property | Type | Description |
| --- | --- | --- |
| `RegistryUrl` | string | URL, identifies the registry. |
| `Nonce` | string | Non-repetition string, must match that of request. |
| `Otc` | string | Unique one-time code identifying the voucher generation request. |

## Voucher creation verification

Request from *instrument* to *registry*, verifying a previous voucher generation request.
This request is usually performed right after submitting a successful voucher generation request (see above).

`POST /api/v1/voucher/verify`

### Payload

```json
{
    "Payload": "<see below>"
}
```

The JSON object `Payload` is encrypted with the *registry’s public key* and has the following structure:

```json
{
    "Otc": "8b7abe3dda5f42e0b8235a819b0088b8"
}
```

| Property | Type | Description |
| --- | --- | --- |
| `Otc` | string | Unique one-time code identifying the voucher generation request, previously generated by a *voucher creation request*. |

### Result

This method will return an empty response with HTTP&nbsp;status `200` to confirm verification.

## Voucher redemption

Request from *pocket* to *registry*, completing the voucher generation request and returning instances of vouchers to the pocket, which can use them to process payments.

`POST /api/v1/voucher/redeem`

### Payload

```json
{
    "Payload": "<see below>"
}
```

`Payload` is a JSON-encoded object, encrypted with the *registry's public key*.
Contents of the object are shown below:

| Property | Type | Description |
| --- | --- | --- |
| `Otc` | string | Uniquely represents the voucher generation instance. Is a GUID in the current implementation. |
| `Password` | string | Short user-provided code that secures transmission of the `Otc`. 4 to 8 numeric characters. |
| `SessionKey` | string | 256-bit session key used to encrypt the response. Encoded in base64. |

### Result

```json
{
    "Payload": "<see below>"
}
```

`Payload` is a JSON-encoded object, encrypted with the *session key* specified in the request.
Encryption makes use of the 256-bit AES&nbsp;algorithm, with PKCS#7 padding.
Contents of the object are shown below:

```json
{
    "Vouchers": [ { } ]
}
```

Each voucher object has the following properties:

| Property | Type | Description |
| --- | --- | --- |
| `Id` | integer | Unique voucher ID. |
| `Secret` | string | Sequence of random bytes (16&nbsp;in current implementation), encoded in base64. |
| `Aim` | string | URL representing the voucher’s aim. |
| `Latitude` | number | |
| `Longitude` | number | |
| `Timestamp` | string | Time and date, UTC, ISO&nbsp;8601 format. |

# Payment generation

Coming soon.

# Payment processing

Coming soon.
